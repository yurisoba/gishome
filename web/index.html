<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>GIShome 24h Query</title>
    <meta name="viewport" content="width=device-width" />

    <!-- google charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- google charts -->

    <!-- graph -->
    <script src="https://unpkg.com/webcola/WebCola/cola.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"
      integrity="sha512-gEWKnYYa1/1c3jOuT9PR7NxiVI1bwn02DeJGsl+lMVQ1fWMNvtjkjxIApTdbJ/wcDjQmbf+McWahXwipdC9bGA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script src="https://cytoscape.org/cytoscape.js-cola/cytoscape-cola.js"></script>
    <!-- graph -->

    <!-- mapbox -->
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.js"></script>
    <script src="https://unpkg.com/h3-js"></script>
    <!-- mapbox -->

    <!-- vue -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="./vue/components.js" type="module"></script>
    <!-- vue -->

    <!-- neo4j -->
    <script src="https://unpkg.com/neo4j-driver@5.3.0/lib/browser/neo4j-web.min.js"></script>
    <!-- neo4j -->

    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <section id="app_component">
      <Info />
    </section>
    <section id="cy_container" class="graph-container hide">
      <div id="cy" class="graph"></div>
    </section>
    <script>
      var colors = {
        enfasis: "#FF0084",
      };
      var cy = cytoscape({
        container: document.getElementById("cy"),
        style: [
          // the stylesheet for the graph
          {
            selector: "node",
            style: {
              "background-color": "#666",
              label: "data(id)",
            },
          },

          {
            selector: "edge",
            style: {
              width: 3,
              "line-color": colors.enfasis,
              "target-arrow-color": colors.enfasis,
              "target-arrow-shape": "triangle",
              "curve-style": "bezier",
            },
          },
        ],
        layout: {name: "cola"},
      });
      const layout = cy.layout({name:"cola"});

      const driver = neo4j.driver(
              "bolt://localhost",
              neo4j.auth.basic("neo4j", "helios")
      );
      const result = {};
      const session = driver.session({ defaultAccessMode: neo4j.session.READ });
      session
              .run(`MATCH p = (a:Product {id:4294424})-[:CONTAINS*4..4]-(b:Product)
RETURN *
LIMIT 100`, {product:4294424})
              .subscribe({
                onNext: record => {
                  const p = record.get("p");
                  result[p.end.elementId] = {
                    node: p.end.properties,
                    path: p.segments,
                  };
                },
                onCompleted: () => {
                  const nodes = {};
                  const edges = {};
                  for (const [eid, e] of Object.entries(result)) {
                    //let prevEnd = null;
                    e.path.forEach(r => {
                      nodes[r.start.elementId] = r.start.properties;
                      nodes[r.start.elementId].label = r.start.labels[0];
                      nodes[r.end.elementId] = r.end.properties;
                      nodes[r.end.elementId].label = r.end.labels[0];
                      let edgeid = r.start.elementId + r.end.elementId;
                      edges[edgeid] = {start: r.start.elementId, end: r.end.elementId};
                      //edges[r.start.elementId] = r.end.elementId;
                      //prevEnd =  r.end.elementId;
                    });
                    nodes[eid] = e.node;
                    nodes[eid].is_end = true;
                    nodes[eid].label = "Product";
                  }
                  const add = [];
                  for (const [id, n] of Object.entries(nodes)) {
                    let data = n;
                    data.id = id;
                    add.push({group: "nodes", data: data});
                  }
                  for (const [eid, e] of Object.entries(edges)) {
                    add.push({group: "edges", data: {id: eid, source: e.start, target: e.end}})
                  }

                  cy.add(add);
                  layout.run();
                },
              });
    </script>
  </body>
</html>
